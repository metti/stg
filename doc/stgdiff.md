# `stgdiff`

`stgdiff` is used to compare ABI representations from various sources, like
libabigail, BTF, or ELF/DWARF.

## Usage

```
stgdiff
 [-m|--metrics]
 [-a|--abi|-b|--btf|-e|--elf] file1
 [-a|--abi|-b|--btf|-e|--elf] file2
 [{-x|--exact}]
 [{-c|--compare-options} {ignore_symbol_type_presence_changes|ignore_type_declaration_status_changes|all}]
 [{-f|--format} {plain|flat|small|short|viz}]
 [{-o|--output} {filename|-}] ...
   implicit defaults: --abi --format plain
   format and output can appear multiple times
   multiple comma-separated compare-options can be passed
   --exact (node equality) cannot be combined with --output
```

## Input formats

*   `-a|--abi`

    Read ABI XML representation generated by libabigail's `abidw`. It is very
    strongly recommended that ABI XML be passed through `abitidy --all` first as
    `stgdiff` cannot resolve issues such as duplicate types in "untidy" XML.

*   `-b|--btf`

    Read ABI information from the `.BTF` ELF section. BTF only covers the C type
    system and can be obtained in the following ways:

    *   `gcc -gbtf` generates BTF instead of DWARF
    *   `clang -c -g -target bpf` works similarly, but only for BPF targets
    *   `pahole -J` reads existing DWARF debug information and adds BTF

*   `-e|--elf`

    Read ABI information, stored inside ELF in DWARF format.

    NOTE: Only ELF symbol information, and not DWARF type information, is
    currently processed.

## Compare options

The options here suppress noisy diffs that are inevitable when consuming ABI XML
output from `abidw`.

*   `ignore_symbol_type_presence_changes`

    Ignore changes in the presence of types for symbols, thus `stgdiff` does not
    report loss or gain of symbol type information.

*   `ignore_type_declaration_status_changes`

    Ignore changes in declaration status of types, thus `stgdiff` does not
    report loss or gain of user-defined type definitions.

*   `all`

    Ignore all types of changes listed above.

## Output formats

All outputs are based on a diff graph which is rooted at the comparison of two
symbol table nodes.

*   `plain`

    Serialise the diff graph via depth first search, avoiding revisiting nodes
    that have been visited or are being visited. The report mirrors the search
    tree.

    This format is only suitable for small inputs because the indentation level
    is proportional to recursion depth and the resulting output may be
    unreadable.

    Example:

    ```
    function symbol 'unsigned int fun(enum A, enum B)' changed
      type 'unsigned int(enum A, enum B)' changed
        parameter 1 type 'enum A' changed
          enumerator 'Ae' value changed from 0 to 1
        parameter 2 type 'enum B' changed
          enumerator 'Be' value changed from 1 to 2
    ```

*   `flat`

    Serialise the diff graph being broken into smaller pieces, each rooted at a
    symbol, a user-defined type or a primitive type. Each piece is serialised as
    a tree at the top level.

    Example:

    ```
    function symbol 'unsigned int fun(enum A, enum B)' changed
      type 'unsigned int(enum A, enum B)' changed
        parameter 1 type 'enum A' changed
        parameter 2 type 'enum B' changed

    type 'enum A' changed
      enumerator 'Ae' value changed from 0 to 1

    type 'enum B' changed
      enumerator 'Be' value changed from 1 to 2
    ```

*   `small`

    Like the `flat` output, but any subtrees that contain no diffs are pruned.
    This report excludes symbols and types that have changed only due to some
    other type change.

    Example:

    ```
    type 'enum A' changed
      enumerator 'Ae' value changed from 0 to 1

    type 'enum B' changed
      enumerator 'Be' value changed from 1 to 2
    ```

*   `short`

    The `short` report is a result of the following post-processing
    transformations on the `small` report:

    *   Changes in symbols where only the CRC value has changed are collapsed
        and the total number of changes is reported.
    *   Runs of member offset changes are collapsed and the amount by which the
        offsets have shifted is reported.
    *   Added and removed symbols are reported in a compact manner with variable
        and function symbols separated.

*   `viz`

    Print the difference graph in Graphviz format.

    Example:

    ```
    digraph "ABI diff" {
      "0" [shape=rectangle, label="'symbols'"]
      "1" [label="'unsigned int fun(enum A, enum B)'"]
      "2" [label="'unsigned int(enum A, enum B)'"]
      "3" [color=red, shape=rectangle, label="'enum A'"]
      "3" -> "3:0"
      "3:0" [color=red, label="enumerator 'Ae' value changed from 0 to 1"]
      "2" -> "3" [label="parameter 1"]
      "4" [color=red, shape=rectangle, label="'enum B'"]
      "4" -> "4:0"
      "4:0" [color=red, label="enumerator 'Be' value changed from 1 to 2"]
      "2" -> "4" [label="parameter 2"]
      "1" -> "2" [label=""]
      "0" -> "1" [label=""]
    }
    ```

## Exact Node Equality

**  `-x|--exact`: perform exact node equality (ignoring node identity) instead
    of generating an ABI equivalence diff graph; no outputs may be specified.

## Other options:

*   `-m|--metrics`: print duration of ABI parsing, comparison and reporting.

*   `--process-dwarf`: enable DWARF processing, when reading ELF files. For
    other formats this options does nothing.

## Return code

If input files' ABIs are equivalent, `stgdiff` will return 0. Otherwise:

*   Return code 1: there was an exception during comparison, see `stderr` for
    the exception reason.
*   Return code 4: ABIs are not equivalent.

## Examples

*   Compare two ABI XML files, and print a short report to stdout:

    ```
    stgdiff -f short -a abi.0.xml abi.1.xml -o -
    ```

*   Compare two ABI XML files **without printing anything**:

    ```
    stgdiff abi.0.xml abi.1.xml && echo "Equivalent" || echo "Not equivalent, return code: $?"
    ```

*   Compare two ABI XML files, print short report to stdout and also print diff
    graph visualisation to the file:

    ```
    stgdiff abi.0.xml abi.1.xml -f short -o - -f viz -o graph.viz
    ```

*   Compare two ABI XML files, ignore type presence and type declaration status
    changes, and print short report to stdout:

    ```
    stgdiff -f short -c ignore_symbol_type_presence_changes,ignore_type_declaration_status_changes -a abi.0.xml abi.1.xml -o -
    ```

*   Compare ABI XML to ABI from ELF and print a short report to file:

    ```
    stgdiff -f short -a abi.xml -e example.o -o example.diff
    ```
