# `stg`

`stg` is used to extract and process ABI representations from libabigail XML,
BTF and ELF/DWARF.

NOTE: This is a work in progress and should be considered *experimental*. All
arguments and behaviour are subject to change.

## Synopsis

```
stg
  [-m|--metrics]
  [-i|--info]
  [-d|--keep-duplicates]
  [-u|--unstable]
  [-S|--symbols <filter>]
  [--process-dwarf]
  [-a|--abi|-b|--btf|-e|--elf|-s|--stg] [file] ...
  [{-o|--output} {filename|-}] ...
implicit defaults: --abi
symbol filter syntax:
  <filter>   ::= <term>          |  <expression> '|' <term>
  <term>     ::= <factor>        |  <term> '&' <factor>
  <factor>   ::= <atom>          |  '!' <factor>
  <atom>     ::= ':' <filename>  |  <glob>  |  '(' <expression> ')'
  <filename> ::= <string>
  <glob>     ::= <string>
```

## Input

The tool can be passed any number of inputs to combine into a unified ABI.

### Formats

*   `-a|--abi`

    Read ABI XML representation generated by libabigail's `abidw`. It is very
    strongly recommended that ABI XML be passed through `abitidy --all` first as
    `stgdiff` cannot resolve issues such as duplicate types in "untidy" XML.

*   `-b|--btf`

    Read ABI information from the `.BTF` ELF section. BTF only covers the C type
    system and can be obtained in the following ways:

    *   `gcc -gbtf` generates BTF instead of DWARF
    *   `clang -c -g -target bpf` works similarly, but only for BPF targets
    *   `pahole -J` reads existing DWARF debug information and adds BTF

*   `-e|--elf`

    Read ABI information, stored inside ELF in DWARF format.

    NOTE: Only ELF symbol information, and not DWARF type information, is
    currently processed.

*   `-s|--stg`

    Read ABI information from a `.stg` file.

    NOTE: There are currently no format stability guarantees and this should be
    considered *completely experimental*.

### Options

*   `--process-dwarf`

    Enable DWARF processing, when reading ELF files. For other formats this
    options does nothing.

## Merge

If multiple (or zero) inputs are provided, then a symbol merge operation is run.

The resulting ABI has the union of the inputs' symbols, which must be disjoint.

## Filter

If a symbol filter is supplied, symbols not matching the filter are dropped.

The basic syntactical elements are:

*   `glob` - a glob pattern matching symbol names
*   `:filename` - the name of a file containing a libabigail format symbol list

Filter expressions can be combined with infix disjuction (`|`) and conjunction
(`&`) operators and negated with the prefix (`!`) operator; these obey the usual
precedence rules. Parentheses (`( ... )`) can be used to enclose subexpressions.
Whitespace is not significant, except as a string delimiter.

### Examples

*   `jiffies |panic` - keep just the symbols `jiffies` and `panic`
*   `str*` - keep symbols beginning with `str` such as `strncpy_from_user`
*   `!(*@* & ! *@@*`) - drop versioned symbols that are not the default versions
*   ` !*@*|*@@*` - the same
*   `:include & !:exclude ` - keep symbols that are in the symbol list file
    `include` but not in the symbol list file `exclude`

## Deduplication

ABI representations, particularly merged ones, almost always have some sets of
nodes that are recursively equal. By default, duplicate nodes are eliminated.

*   `-d|--keep-duplicates`

    Skip the deduplication pass.

## Output

*   `-o|--output`

    Zero or more outputs can be requested. The filename `-` is recognised as a
    synonym for stdout.

    The output will be an ABI representation in STG's native format.

    NOTE: There are currently no format stability guarantees and this should be
    considered *completely experimental*.

*   `-u|--unstable`: Use internal node ids in the ABI representation, instead of
    stabilised external node ids.

    This is intended for debugging purposes.

## Diagnostics

*   `-m|--metrics`

    Print various internal timing and other metrics.

*   `-i|--info`

    This causes the BTF and ELF parsers to dump information to stdout about the
    entities processed. This is primarily useful for debugging. In the case of
    BTF input, the output is intended to match the output of `bpftool btf dump
    file "$file" format raw`.
